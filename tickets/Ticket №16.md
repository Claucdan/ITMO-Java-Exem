# Ключевые отличия Apache Kafka от RabbitMQ. Паттерн Outbox.
## Ключевые отличия Apache Kafka и RabbitMQ

### Архитектура
- **RabbitMQ**: Классический *message broker*, работающий по модели "публикация-подписка" или "очереди задач". Использует *exchanges*, *queues* и *bindings* для маршрутизации сообщений.  
- **Kafka**: *Распределённая потоковая платформа*, основанная на партиционированных топиках (topics) и immutable логах. Сообщения хранятся на диске и могут перечитываться.  
### Модель доставки
- **RabbitMQ**:  
  - *Push-модель*: Брокер сам доставляет сообщения потребителям.  
  - Поддерживает *ACK/NACK* для подтверждения обработки.  
  - Удаляет сообщения после обработки (если не настроена персистентность).  
- **Kafka**:  
  - *Pull-модель*: Потребители сами запрашивают данные.  
  - Сообщения хранятся долго (настраиваемый retention period).  
  - Потребители управляют *offset* для отслеживания прогресса.  
### Производительность
- **RabbitMQ**: Оптимизирован для низкой задержки (миллисекунды), но пропускная способность ограничена (тысячи сообщений/сек).  
- **Kafka**: Обрабатывает *миллионы сообщений/сек* благодаря партиционированию и последовательной записи на диск.  
### Использование
- **RabbitMQ** лучше для:  
  - Микросервисов (асинхронная коммуникация).  
  - Сложной маршрутизации (например, topic-based routing).  
  - Задач с гарантированной доставкой (например, транзакции).  
- **Kafka** лучше для:  
  - Потоковой обработки (real-time analytics, IoT).  
  - Хранения и повторной обработки данных (например, event sourcing).  
  - Высоконагруженных систем (например, логирование).  

## Паттерн Outbox
### Проблема
В распределённых системах сложно гарантировать атомарность записи в БД и отправки сообщения в брокер (проблема *dual-write*).  
### Как работает Outbox?
1. **Транзакция в БД**:  
   - Приложение записывает данные в основную таблицу (например, `orders`).  
   - В той же транзакции добавляет событие в таблицу `outbox`.  
2. **Фоновая обработка**:  
   - Отдельный процесс (например, Debezium или кастомный ретранслятор) читает `outbox` и публикует события в Kafka/RabbitMQ.  
3. **Идемпотентность**:  
   - Потребители должны обрабатывать дубликаты (например, по `event_id`).  

### Преимущества Outbox
- **Атомарность**: Нет риска, что данные сохранятся, а событие — нет.  
- **Надёжность**: Сообщения не теряются, даже если брокер недоступен.  
- **Масштабируемость**: Фоновая отправка не блокирует основное приложение.  
### Недостатки
- **Задержка**: События обрабатываются асинхронно (не подходит для real-time).  
- **Сложность**: Требует дополнительных компонентов (например, Debezium).  